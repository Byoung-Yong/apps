<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text Analyzer Clean</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007bff' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'></path><polyline points='14 2 14 8 20 8'></polyline><line x1='16' y1='13' x2='8' y2='13'></line><line x1='16' y1='17' x2='8' y2='17'></line><polyline points='10 9 9 9 8 9'></polyline></svg>">
  <style>
    :root {
      --bg-app: #f1f5f9;
      --bg-panel: #ffffff;
      --bg-hover: #f8fafc;

      --text-main: #334155;
      --text-muted: #64748b;
      --text-dim: #94a3b8;

      --accent: #4f46e5;
      --accent-hover: #4338ca;
      --accent-light: #e0e7ff;

      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;

      --border: #e2e8f0;
      --radius-lg: 16px;
      --radius-md: 8px;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);

      --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: "JetBrains Mono", "Fira Code", Consolas, Monaco, monospace;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-app);
      color: var(--text-main);

      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;

      overflow: hidden;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .app-header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }
    .brand h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      color: #1e293b;
      letter-spacing: -0.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand .badge {
      font-size: 11px;
      padding: 4px 10px;
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 99px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .main-container {
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: 1fr 440px;
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      body { overflow: auto; }

      .main-container {
        grid-template-columns: 1fr;
        overflow: visible;
        min-height: auto;
        flex: 0 0 auto;
      }

      .col-left, .col-right {
        height: auto !important;
        min-height: auto !important;
        border-left: none !important;
      }

      .app-header { padding: 0 20px; }
    }

    /* ‚úÖ Ìå®Îî©/Í∞≠ÏùÑ Ï§ÑÏó¨ÏÑú SettingsÍ∞Ä "Îçî ÏúÑÎ°ú" Ïò¨ÎùºÏò§ÎèÑÎ°ù */
    .col-left {
      display: flex;
      flex-direction: column;
      padding: 20px 28px 64px; /* bottom padding for safe last-card visibility */
      gap: 16px;

      overflow-y: auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;

      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .col-right {
      background: #ffffff;
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      box-shadow: -4px 0 20px rgba(0,0,0,0.02);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: #ffffff;
      padding: 0 20px;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 18px 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: 0.2s;
      margin-right: 8px;
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--accent); }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 24px;
      background: #f8fafc;
      display: none;
      -webkit-overflow-scrolling: touch;
    }
    .tab-content.show { display: block; }

    .toolbar {
      display: flex;
      gap: 10px;
      padding: 12px 18px;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    /* ‚úÖ ÌïµÏã¨: Î©îÏù∏ Ìå®ÎÑêÏù¥ ÌôîÎ©¥ÏùÑ Í≥ºÏ†êÏú†ÌïòÏßÄ ÏïäÎèÑÎ°ù Î∞òÏùëÌòï ÎÜíÏù¥Î°ú Ï†úÌïú */
    .panel-wrapper {
      display: flex;
      flex-direction: column;

      height: clamp(260px, 48vh, 620px); /* ‚Üê SettingsÍ∞Ä Ïß§Î¶¨Îçò Î¨∏Ï†ú Ìï¥Í≤∞ Ìè¨Ïù∏Ìä∏ */
      flex: 0 0 auto;

      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: all 0.2s ease;
      min-height: 260px;
    }
    .panel-wrapper:focus-within {
      box-shadow: var(--shadow-lg);
      border-color: #cbd5e1;
    }

    textarea#textInput {
      flex: 1 1 auto;
      min-height: 0;
      width: 100%;
      background: #0f172a;
      border: none;
      color: #f1f5f9;
      padding: 18px 22px;
      font-size: 16px;
      line-height: 1.8;
      resize: none;
      outline: none;
      font-family: var(--font-sans);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    textarea#textInput::placeholder { color: #64748b; }

    .preview-box {
      flex: 1 1 auto;
      min-height: 0;
      background: #ffffff;
      padding: 16px 22px;
      font-size: 15px;
      line-height: 1.8;
      overflow-y: auto;
      font-family: var(--font-sans);
      white-space: pre-wrap;
      color: var(--text-main);
      -webkit-overflow-scrolling: touch;
    }

    /* Theme Swapped State */
    .panel-wrapper.swapped textarea#textInput {
      background: #ffffff;
      color: #0f172a;
    }
    .panel-wrapper.swapped .preview-box {
      background: #0f172a;
      color: #f1f5f9;
    }
    .panel-wrapper.swapped textarea#textInput::placeholder { color: #94a3b8; }

    .tok { border-radius: 2px; transition: 0.15s; }
    .hit { background: #c7d2fe; color: #312e81; }
    .tok.hit { box-shadow: 0 0 0 1px #a5b4fc; font-weight: 600; }
    .tok.senthit { background: #fef3c7; }

    .settings-box {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px;
      padding: 18px;
      background: #ffffff;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .setting-item label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
    }

    input[type="number"], input[type="text"], select {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      color: var(--text-main);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: 0.2s;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 0 18px 18px;
      background: #ffffff;
    }
    .checkbox-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-main);
      cursor: pointer;
      user-select: none;
      padding: 8px 14px;
      background: #f8fafc;
      border-radius: 99px;
      border: 1px solid var(--border);
      transition: 0.2s;
      font-weight: 500;
    }
    .checkbox-pill:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .checkbox-pill.is-checked {
      background: var(--accent-light);
      border-color: var(--accent-light);
      color: var(--accent);
    }
    .checkbox-pill input { display: none; }

    .bento-card {
      background: #ffffff;
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s;
    }
    .bento-card:hover { box-shadow: var(--shadow-md); }
    .bento-card .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f1f5f9;
    }
    .bento-card .title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .stat-item {
      background: #f8fafc;
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid transparent;
    }
    .stat-item .k { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
    .stat-item .v { font-size: 24px; font-weight: 700; color: #1e293b; letter-spacing: -0.03em; }
    .stat-item .s { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

    .data-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .list-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: transparent;
      border-radius: var(--radius-md);
      font-size: 14px;
      cursor: pointer;
      transition: 0.1s;
      border: 1px solid transparent;
    }
    .list-row:hover {
      background: #f1f5f9;
      border-color: #e2e8f0;
    }
    .list-row .lbl { color: var(--text-main); font-weight: 500; }
    .list-row .val {
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 12px;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
    }

    button.btn {
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }
    button.btn:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
    button.btn:active { transform: translateY(0); }

    button.btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
    }
    button.btn-primary:hover { background: var(--accent-hover); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); }

    button.btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

    details { background: #ffffff; border-top: 1px solid var(--border); }
    details:first-of-type { border-top: none; }
    summary {
      padding: 16px 18px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      color: var(--text-main);
      transition: background 0.2s;
    }
    summary:hover { background: #f8fafc; }
    details .content { padding: 0 18px 18px; }

    .toast {
      position: fixed; bottom: 32px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1e293b; color: #fff;
      padding: 12px 24px; border-radius: 99px;
      font-size: 14px; opacity: 0; pointer-events: none;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 999;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .help-text { font-size: 12px; color: var(--text-muted); margin-top: 4px; display: block; line-height: 1.4; }
    .mono { font-family: var(--font-mono); }
    .hidden { display: none !important; }

    textarea::-webkit-scrollbar { width: 8px; }
    textarea::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }
    textarea::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

    .btn-mode-active { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; }
  </style>
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent);">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <h1>Text Analyzer <span style="font-weight:400; color:var(--text-muted);"></span></h1>

    </div>
    <div style="display:flex; gap:12px;">
      <button class="btn btn-sm" id="resetAllBtn">Reset All</button>
      <button class="btn btn-sm btn-primary" id="exportReportBtn">Export Report</button>
    </div>
  </header>

  <div class="main-container">
    <!-- LEFT -->
    <div class="col-left">

      <div class="panel-wrapper" id="mainPanel">
        <div class="toolbar">
          <div style="display:flex; gap:4px;">
            <button class="btn btn-sm" id="btnEditMode">Input Text</button>
            <button class="btn btn-sm" id="btnReadMode">Analysis Mode</button>
          </div>
          <button class="btn btn-sm" id="btnSwapTheme" style="margin-left:8px;" title="Swap Colors">üåó</button>
          <div style="flex:1;"></div>

          <span id="activeInfo" style="font-size:12px; color:var(--accent); font-weight:700;">No Selection</span>
          <button class="btn btn-sm" id="clearHitBtn" style="border:none; color:var(--text-muted); box-shadow:none;">Clear</button>
        </div>

        <div id="preview" class="preview-box"></div>
        <textarea id="textInput" class="hidden" placeholder="Write or paste your text here (English/Korean mixed)..."></textarea>
      </div>

      <div class="settings-box">
        <details open>
          <summary>Analysis Settings</summary>
          <div class="content" style="padding:0;">
            <div class="settings-grid">
              <div class="setting-item">
                <label>Long Sentence Limit</label>
                <input id="longSentenceThreshold" type="number" value="35" />
              </div>
              <div class="setting-item">
                <label>Repetition Limit (Count)</label>
                <input id="overusedMinCount" type="number" value="8" />
              </div>
              <div class="setting-item">
                <label>Local Window Size</label>
                <input id="localRepeatWindow" type="number" value="40" />
              </div>
              <div class="setting-item">
                <label>Top N Items</label>
                <input id="topN" type="number" value="25" />
              </div>
            </div>

            <div class="checkbox-group">
              <label class="checkbox-pill"><input id="useStopwords" type="checkbox" checked /> Use Stopwords</label>
              <label class="checkbox-pill"><input id="countNumbers" type="checkbox" /> Count Numbers</label>
              <label class="checkbox-pill"><input id="ng2" type="checkbox" checked /> 2-gram</label>
              <label class="checkbox-pill"><input id="ng3" type="checkbox" checked /> 3-gram</label>
            </div>
          </div>
        </details>

        <details>
          <summary>Custom Stopwords</summary>
          <div class="content" style="padding-top:16px;">
            <textarea id="stopwordsInput" class="mono" style="width:100%; height:84px; background:#f8fafc; border:1px solid #cbd5e1; color:var(--text-main); padding:12px; border-radius:8px; font-size:12px; resize:vertical; outline:none; transition:0.2s;"></textarea>
            <div style="display:flex; gap:8px; margin-top:12px;">
              <button class="btn btn-sm" id="resetStopwordsBtn">Reset Default</button>
              <button class="btn btn-sm" id="clearStorageBtn" style="color:var(--danger); border-color:transparent;">Clear Cache</button>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-right">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('tab-quality')">Quality</button>
        <button class="tab-btn" onclick="switchTab('tab-academic')">Academic</button>
        <button class="tab-btn" onclick="switchTab('tab-data')">Data</button>
      </div>

      <div id="tab-overview" class="tab-content show">
        <div class="bento-card">
          <div class="card-head"><div class="title">Basic Statistics</div></div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="k">WORDS</div>
              <div class="v" id="statWords">0</div>
              <div class="s" id="statWordsSub">unique: 0</div>
            </div>
            <div class="stat-item">
              <div class="k">CHARACTERS</div>
              <div class="v" id="statChars">0</div>
              <div class="s">including spaces</div>
            </div>
            <div class="stat-item">
              <div class="k">SENTENCES</div>
              <div class="v" id="statSents">0</div>
              <div class="s" id="statLenSub">avg len: 0</div>
            </div>
            <div class="stat-item">
              <div class="k">READING TIME</div>
              <div class="v" id="statRead">0</div>
              <div class="s">est. @200wpm</div>
            </div>
          </div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Top Words</div></div>
          <div id="topWordsBody" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Readability (English)</div></div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="k">FLESCH READING EASE</div>
              <div class="v" id="fleschRE">‚Äî</div>
            </div>
            <div class="stat-item">
              <div class="k">GRADE LEVEL</div>
              <div class="v" id="fkGrade">‚Äî</div>
            </div>
          </div>
          <div style="margin-top:12px; font-size:12px; color:var(--text-muted); background:#f1f5f9; padding:8px; border-radius:6px;" id="enCounts">Insufficient English text</div>
        </div>
      </div>

      <div id="tab-quality" class="tab-content">
        <div class="bento-card">
          <div class="card-head"><div class="title">Long Sentences</div></div>
          <div class="help-text" style="margin-bottom:12px;">Sentences exceeding threshold. Click to jump.</div>
          <div id="longSentencesList" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Passive Voice Suspects</div></div>
          <div class="help-text" style="margin-bottom:12px;">Heuristic: be-verb + past participle</div>
          <div id="passiveList" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Local Repetition</div></div>
          <div class="help-text" style="margin-bottom:12px;">Same word used frequently in a short span</div>
          <div id="localRepeatList" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Transitions</div></div>
          <div id="transitionBody" class="data-list"></div>
        </div>
      </div>

      <div id="tab-academic" class="tab-content">
        <div class="bento-card">
          <div class="card-head"><div class="title">Document Structure</div></div>
          <div id="sectionBody" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Citations Detected</div></div>
          <div id="citeBody" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Abbreviations Defined</div></div>
          <div id="abbrBody" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Keyword Density Analysis</div></div>
          <textarea id="densityKeywords" placeholder="Enter keywords (comma separated) to analyze density by section..." style="width:100%; background:#f8fafc; border:1px solid #cbd5e1; color:var(--text-main); padding:10px; font-size:13px; border-radius:8px; margin-bottom:12px; resize:vertical;"></textarea>
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:12px; color:var(--text-muted);">
              <thead id="densityHead" style="text-align:left; border-bottom:1px solid var(--border);"></thead>
              <tbody id="densityBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-data" class="tab-content">
        <div class="bento-card">
          <div class="card-head"><div class="title">N-Grams (Phrases)</div></div>
          <div id="ngramsBody" class="data-list"></div>
        </div>

        <div class="bento-card">
          <div class="card-head"><div class="title">Data Export</div></div>
          <div style="display:flex; flex-direction:column; gap:12px;">
            <button class="btn" id="exportWordsCsvBtn">Download Word Frequencies (CSV)</button>
            <button class="btn" id="exportNgramsCsvBtn">Download N-Grams (CSV)</button>
            <button class="btn" id="copyReportBtn">Copy Full Report to Clipboard</button>

            <div style="margin-top:16px; padding-top:16px; border-top:1px solid #f1f5f9; display:flex; gap:10px;">
              <button class="btn btn-sm" style="flex:1;" id="exportStopwordsBtn">Export Stopwords</button>
              <button class="btn btn-sm" style="flex:1;" id="importStopwordsBtn">Import Stopwords</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Message</div>

  <script>
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById(tabId).classList.add('show');
      const btns = document.querySelectorAll('.tab-btn');
      if(tabId === 'tab-overview') btns[0].classList.add('active');
      if(tabId === 'tab-quality') btns[1].classList.add('active');
      if(tabId === 'tab-academic') btns[2].classList.add('active');
      if(tabId === 'tab-data') btns[3].classList.add('active');
    }

    const DEFAULTS = {
      longSentenceThreshold: 35,
      overusedMinCount: 8,
      topN: 25,
      useStopwords: true,
      countNumbers: false,
      ng2: true,
      ng3: true,
      localRepeatWindow: 40
    };

    const STORAGE_KEYS = {
      text: "ta_text_v6",
      stopwords: "ta_stopwords_v6",
      settings: "ta_settings_v6",
      densityKeywords: "ta_density_keywords_v6",
      mode: "ta_mode_v6"
    };

    const DEFAULT_STOPWORDS_EN = [
      "a","about","above","after","again","against","all","am","an","and","any","are","aren't","as","at","be","because","been",
      "before","being","below","between","both","but","by","can","can't","cannot","could","couldn't","did","didn't","do","does",
      "doesn't","doing","don't","down","during","each","few","for","from","further","had","hadn't","has","hasn't","have","haven't",
      "having","he","he'd","he'll","he's","her","here","here's","hers","herself","him","himself","his","how","how's","i","i'd",
      "i'll","i'm","i've","if","in","into","is","isn't","it","it's","its","itself","just","let's","me","more","most","mustn't",
      "my","myself","no","nor","not","now","of","off","on","once","only","or","other","ought","our","ours","ourselves","out",
      "over","own","same","shan't","she","she'd","she'll","she's","should","shouldn't","so","some","such","than","that","that's",
      "the","their","theirs","them","themselves","then","there","there's","these","they","they'd","they'll","they're","they've",
      "this","those","through","to","too","under","until","up","very","was","wasn't","we","we'd","we'll","we're","we've","were",
      "weren't","what","what's","when","when's","where","where's","which","while","who","who's","whom","why","why's","with",
      "won't","would","wouldn't","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves"
    ];

    const DEFAULT_STOPWORDS_KO = [
      "ÏùÄ","Îäî","Ïù¥","Í∞Ä","ÏùÑ","Î•º","Ïóê","Ïùò","ÏôÄ","Í≥º","ÎèÑ","Î°ú","ÏúºÎ°ú","ÏóêÏÑú","Î∂ÄÌÑ∞","ÍπåÏßÄ","Í∑∏Î¶¨Í≥†","ÌïòÏßÄÎßå","Í∑∏Îü¨ÎÇò","ÎòêÎäî",
      "ÎòêÌïú","Î∞è","Îòê","Ï¶â","ÏòàÎ•º","Îì§Ïñ¥","ÎïåÎ¨∏Ïóê","Í∞ôÏùÄ","Í∞ôÏù¥","ÎåÄÌïú","ÎåÄÌï¥","ÌÜµÌï¥","ÏúÑÌï¥","Îì±","Ïàò","Ï¢Ä","Îçî","Í∞ÄÏû•","Îß§Ïö∞",
      "Ï†ïÎèÑ","Îïå","Í≤É","Í±∞","Îì§","Ìï®","Ìï©ÎãàÎã§","Ïù¥Îã§","ÏòÄÎã§","ÏûàÎäî","ÏóÜÎäî","ÌïòÎäî","ÌïúÎã§","ÌïòÏòÄÎã§"
    ];

    const TRANSITIONS = [
      "however","therefore","moreover","furthermore","thus","hence","additionally","in addition","consequently","nevertheless",
      "nonetheless","meanwhile","instead","for example","for instance","in contrast","on the other hand","in summary","overall",
      "in conclusion","specifically","notably","similarly","likewise","as a result","in particular","in general","in fact",
      "in other words","to summarize"
    ];

    const IRREGULAR_PARTICIPLES = new Set([
      "given","shown","known","seen","done","made","found","taken","built","bought","brought","caught","chosen","come","become",
      "cut","dealt","drawn","driven","eaten","fallen","felt","fought","gone","grown","held","kept","left","lent","lost","met",
      "paid","put","read","run","said","set","sent","spent","stood","taught","told","thought","understood","written","sought",
      "sold","won"
    ]);

    const HEADING_KEYWORDS = [
      "abstract","introduction","background","methods","materials and methods","experimental","results","discussion","conclusion",
      "conclusions","references","acknowledgements","acknowledgments","supporting information","supplementary information"
    ];

    const ELS = {
      btnReadMode: document.getElementById("btnReadMode"),
      btnEditMode: document.getElementById("btnEditMode"),
      btnSwapTheme: document.getElementById("btnSwapTheme"),
      mainPanel: document.getElementById("mainPanel"),

      textInput: document.getElementById("textInput"),
      preview: document.getElementById("preview"),

      stopwordsInput: document.getElementById("stopwordsInput"),
      densityKeywords: document.getElementById("densityKeywords"),

      longSentenceThreshold: document.getElementById("longSentenceThreshold"),
      overusedMinCount: document.getElementById("overusedMinCount"),
      localRepeatWindow: document.getElementById("localRepeatWindow"),
      topN: document.getElementById("topN"),

      useStopwords: document.getElementById("useStopwords"),
      countNumbers: document.getElementById("countNumbers"),
      ng2: document.getElementById("ng2"),
      ng3: document.getElementById("ng3"),

      statWords: document.getElementById("statWords"),
      statChars: document.getElementById("statChars"),
      statSents: document.getElementById("statSents"),
      statRead: document.getElementById("statRead"),
      statWordsSub: document.getElementById("statWordsSub"),
      statLenSub: document.getElementById("statLenSub"),

      topWordsBody: document.getElementById("topWordsBody"),
      ngramsBody: document.getElementById("ngramsBody"),

      longSentencesList: document.getElementById("longSentencesList"),
      passiveList: document.getElementById("passiveList"),
      localRepeatList: document.getElementById("localRepeatList"),
      transitionBody: document.getElementById("transitionBody"),

      citeBody: document.getElementById("citeBody"),
      abbrBody: document.getElementById("abbrBody"),
      sectionBody: document.getElementById("sectionBody"),

      densityHead: document.getElementById("densityHead"),
      densityBody: document.getElementById("densityBody"),

      fleschRE: document.getElementById("fleschRE"),
      fkGrade: document.getElementById("fkGrade"),
      enCounts: document.getElementById("enCounts"),

      activeInfo: document.getElementById("activeInfo"),
      clearHitBtn: document.getElementById("clearHitBtn"),

      resetAllBtn: document.getElementById("resetAllBtn"),
      exportReportBtn: document.getElementById("exportReportBtn"),

      exportWordsCsvBtn: document.getElementById("exportWordsCsvBtn"),
      exportNgramsCsvBtn: document.getElementById("exportNgramsCsvBtn"),
      copyReportBtn: document.getElementById("copyReportBtn"),

      resetStopwordsBtn: document.getElementById("resetStopwordsBtn"),
      exportStopwordsBtn: document.getElementById("exportStopwordsBtn"),
      importStopwordsBtn: document.getElementById("importStopwordsBtn"),
      clearStorageBtn: document.getElementById("clearStorageBtn"),

      toast: document.getElementById("toast")
    };

    let state = {
      mode: "edit",
      tokens: [],
      tokenNorms: [],
      tokenPositions: [],
      wordCounts: [],
      ngramCounts: [],
      hasRenderHighlights: false,
      lastReport: ""
    };
    let navState = { key: null, hits: [], index: 0 };

    function toast(msg){
      ELS.toast.textContent = msg;
      ELS.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => ELS.toast.classList.remove("show"), 1600);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function escapeRegex(str){
      return String(str ?? "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function formatNumber(x){ return (x ?? 0).toLocaleString(); }
    function normalizeToken(t){ return /[A-Za-z]/.test(t) ? t.toLowerCase() : t; }

    function parseStopwords(t){
      return new Set(
        (t || "")
          .split(/[\n,]+/g)
          .map(s => normalizeToken(s.trim()))
          .filter(Boolean)
      );
    }

    function getDefaultStopwordsText(){
      return [...new Set([...DEFAULT_STOPWORDS_EN, ...DEFAULT_STOPWORDS_KO])].join("\n");
    }

    function tokenizeWithOffsets(raw, countNumbers){
      const re = /[A-Za-z]+(?:'[A-Za-z]+)?|[0-9]+(?:\.[0-9]+)?|[Í∞Ä-Ìû£]+/g;
      const tokens = [];
      let m;
      while((m = re.exec(raw)) !== null){
        const token = m[0];
        if(!countNumbers && /^[0-9]+(?:\.[0-9]+)?$/.test(token)) continue;
        tokens.push({ token, norm: normalizeToken(token), start: m.index, end: m.index + token.length });
      }
      return tokens;
    }

    function tokenizeEnglishWords(text){
      const m = text.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g);
      return m ? m.map(w => w.toLowerCase()) : [];
    }

    function splitSentencesWithOffsets(raw){
      const re = /[^.!?„ÄÇÔºüÔºÅ\n]+[.!?„ÄÇÔºüÔºÅ]+|[^.!?„ÄÇÔºüÔºÅ\n]+(?=\n)|[^.!?„ÄÇÔºüÔºÅ\n]+$/g;
      const out = [];
      let m;
      while((m = re.exec(raw)) !== null){
        const cleaned = m[0].trim();
        if(cleaned.length > 0) out.push({ start: m.index, end: m.index + m[0].length, text: cleaned });
      }
      return out;
    }

    function countParagraphs(raw){
      return raw.trim()
        ? raw.split(/\n\s*\n/g).filter(s => s.trim().length > 0).length
        : 0;
    }

    function estimateReadingTime(words){
      const m = Math.round(words / 200);
      return m < 1 ? "<1 min" : `${m} min`;
    }

    function estimateSyllables(w){
      w = w.toLowerCase().replace(/[^a-z]/g,"");
      if(w.length === 0) return 0;
      if(w.length <= 3) return 1;
      w = w.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,"").replace(/^y/,"");
      return (w.match(/[aeiouy]{1,2}/g) || []).length || 1;
    }

    function buildNgrams(tokens, stop, n, useStop){
      const counts = new Map();
      for(let i = 0; i + n <= tokens.length; i++){
        const slice = tokens.slice(i, i + n);
        if(useStop && slice.some(t => stop.has(t.norm))) continue;
        const txt = slice.map(t => t.norm).join(" ");
        counts.set(txt, (counts.get(txt) || 0) + 1);
      }
      return [...counts.entries()].map(([k,v]) => ({ text: k, count: v }));
    }

    function updateCheckboxPills(){
      document.querySelectorAll(".checkbox-pill input").forEach(inp => {
        inp.parentElement.classList.toggle("is-checked", inp.checked);
      });
    }

    function readSettings(){
      return {
        longSentenceThreshold: Number(ELS.longSentenceThreshold.value),
        overusedMinCount: Number(ELS.overusedMinCount.value),
        localRepeatWindow: Number(ELS.localRepeatWindow.value),
        topN: Number(ELS.topN.value),
        useStopwords: !!ELS.useStopwords.checked,
        countNumbers: !!ELS.countNumbers.checked,
        ng2: !!ELS.ng2.checked,
        ng3: !!ELS.ng3.checked
      };
    }

    function applySettings(s){
      const x = { ...DEFAULTS, ...(s || {}) };
      ELS.longSentenceThreshold.value = x.longSentenceThreshold;
      ELS.overusedMinCount.value = x.overusedMinCount;
      ELS.localRepeatWindow.value = x.localRepeatWindow;
      ELS.topN.value = x.topN;
      ELS.useStopwords.checked = x.useStopwords;
      ELS.countNumbers.checked = x.countNumbers;
      ELS.ng2.checked = x.ng2;
      ELS.ng3.checked = x.ng3;
    }

    function setMode(mode, opts={}){
      state.mode = mode;
      const isRead = mode === "read";
      ELS.preview.classList.toggle("hidden", !isRead);
      ELS.textInput.classList.toggle("hidden", isRead);

      ELS.btnReadMode.classList.toggle("btn-mode-active", isRead);
      ELS.btnEditMode.classList.toggle("btn-mode-active", !isRead);

      localStorage.setItem(STORAGE_KEYS.mode, mode);

      if(isRead){
        if(!opts.skipAnalyze) analyze();
      } else {
        if(!opts.noFocus) {
          ELS.textInput.focus();
          const v = ELS.textInput.value;
          ELS.textInput.setSelectionRange(v.length, v.length);
        }
      }
    }

    function ensureReadMode(){
      if(state.mode !== "read") setMode("read", { skipAnalyze: false, noFocus: false });
    }

    function renderPreview(raw, tokens, highlights=[]){
      const MAX_TOKENS = 25000;
      const safe = tokens.length > MAX_TOKENS ? tokens.slice(0, MAX_TOKENS) : tokens;

      state.tokenNorms = safe.map(t => t.norm);
      state.tokenPositions = safe.map(t => ({ start: t.start, end: t.end }));
      state.hasRenderHighlights = highlights.length > 0;

      const isHit = new Uint8Array(raw.length);
      highlights.forEach(h => {
        for(let i=h.start; i<h.end; i++) isHit[i] = 1;
      });

      function getSeg(text, start){
        let html = "";
        let inHit = false;
        let chunk = "";
        for(let i=0; i<text.length; i++){
          const hit = isHit[start + i] === 1;
          if(hit !== inHit){
            if(chunk) html += escapeHtml(chunk);
            chunk = "";
            if(hit) html += '<span class="hit">';
            else html += '</span>';
            inHit = hit;
          }
          chunk += text[i];
        }
        if(chunk) html += escapeHtml(chunk);
        if(inHit) html += '</span>';
        return html;
      }

      let html = "";
      let pos = 0;
      for(let i=0; i<safe.length; i++){
        const t = safe[i];
        if(t.start > pos) html += getSeg(raw.slice(pos, t.start), pos);
        
        const tokenHit = isHit[t.start] === 1;
        const cls = tokenHit ? "tok hit" : "tok";
        html += `<span class="${cls}" id="tok-${i}">${escapeHtml(raw.slice(t.start, t.end))}</span>`;
        pos = t.end;
      }
      html += getSeg(raw.slice(pos), pos);

      if(tokens.length > MAX_TOKENS) html += "\n\n[Truncated for performance]";
      ELS.preview.innerHTML = html;
    }

    function clearHighlights(){
      ensureReadMode();
      if(state.hasRenderHighlights){
        renderPreview(ELS.textInput.value, state.tokens || [], []);
      } else {
        ELS.preview.querySelectorAll(".hit, .senthit").forEach(el => el.classList.remove("hit","senthit"));
      }
      ELS.activeInfo.textContent = "No Selection";
      navState = { key: null, hits: [], index: 0 };
    }

    function highlightWord(norm){
      ensureReadMode();
      const key = `w:${norm}`;
      if(navState.key === key && navState.hits.length > 0){
        navState.index = (navState.index + 1) % navState.hits.length;
      } else {
        clearHighlights();
        const hits = [];
        state.tokenNorms.forEach((n,i) => { if(n === norm) hits.push(i); });
        if(hits.length === 0) { toast("Word not found"); return; }
        hits.forEach(i => document.getElementById(`tok-${i}`)?.classList.add("hit"));
        navState = { key, hits, index: 0 };
      }
      const i = navState.hits[navState.index];
      document.getElementById(`tok-${i}`)?.scrollIntoView({ behavior:"smooth", block:"center" });
      ELS.activeInfo.textContent = `Word: "${norm}" (${navState.index + 1}/${navState.hits.length})`;
    }

    function highlightRange(start, end, isSentence=false){
      ensureReadMode();
      clearHighlights();

      let sIdx = state.tokenPositions.findIndex(p => p.end > start);
      if(sIdx === -1) { toast("Range not found in preview"); return; }

      let eIdx = sIdx;
      while(eIdx < state.tokenPositions.length && state.tokenPositions[eIdx].start < end) eIdx++;

      for(let i=sIdx; i<eIdx; i++){
        const el = document.getElementById(`tok-${i}`);
        if(el) el.classList.add(isSentence ? "senthit" : "hit");
      }

      document.getElementById(`tok-${sIdx}`)?.scrollIntoView({ behavior:"smooth", block:"center" });
      ELS.activeInfo.textContent = isSentence ? "Sentence Highlighted" : "Range Highlighted";
    }

    /* ‚úÖ N-gram ÌïòÏù¥ÎùºÏù¥Ìä∏ (Î™®Îì† Îì±Ïû• ÏúÑÏπò ÌëúÏãú) */
    function highlightNgram(phrase){
      ensureReadMode();
      const key = `ng:${phrase}`;
      if(navState.key === key && navState.hits.length > 0){
        navState.index = (navState.index + 1) % navState.hits.length;
      } else {
        clearHighlights();
        const parts = String(phrase || "").trim().split(/\s+/g).filter(Boolean);
        if(parts.length < 1) { toast("Invalid n-gram"); return; }
        const n = parts.length;
        const norms = state.tokenNorms;
        const hits = [];
        for(let i=0; i + n <= norms.length; i++){
          let ok = true;
          for(let k=0; k<n; k++){
            if(norms[i+k] !== parts[k]) { ok = false; break; }
          }
          if(ok) hits.push(i);
        }
        if(!hits.length) { toast("Phrase not found"); return; }
        for(const i of hits){
          for(let k=0; k<n; k++){
            document.getElementById(`tok-${i+k}`)?.classList.add("hit");
          }
        }
        navState = { key, hits, index: 0 };
      }
      const i = navState.hits[navState.index];
      document.getElementById(`tok-${i}`)?.scrollIntoView({ behavior:"smooth", block:"center" });
      ELS.activeInfo.textContent = `Phrase: "${phrase}" (${navState.index + 1}/${navState.hits.length})`;
    }

    function highlightText(str){
      ensureReadMode();
      const key = `txt:${str}`;
      if(navState.key === key && navState.hits.length > 0){
        navState.index = (navState.index + 1) % navState.hits.length;
      } else {
        const hits = [];
        const raw = ELS.textInput.value;
        let pos = raw.indexOf(str);
        while(pos !== -1){
          hits.push({ start: pos, end: pos + str.length });
          pos = raw.indexOf(str, pos + 1);
        }
        if(!hits.length) { toast("Not found"); return; }
        
        renderPreview(raw, state.tokens || [], hits);
        navState = { key, hits, index: 0 };
      }
      const h = navState.hits[navState.index];
      const sIdx = state.tokenPositions.findIndex(p => p.end > h.start);
      if(sIdx !== -1) document.getElementById(`tok-${sIdx}`)?.scrollIntoView({ behavior:"smooth", block:"center" });
      ELS.activeInfo.textContent = `Match: "${str}" (${navState.index + 1}/${navState.hits.length})`;
    }

    function renderList(el, items, clickFn){
      if(!items || !items.length){
        el.innerHTML = `<div style="padding:12px; color:var(--text-dim); font-size:13px; text-align:center;">No data found</div>`;
        return;
      }
      el.innerHTML = items.map(item => `
        <div class="list-row">
          <div style="display:flex; flex-direction:column; gap:2px;">
            <div class="lbl" ${item.color ? `style="color:${item.color}"` : ""}>${escapeHtml(item.label)}</div>
            ${item.sub ? `<div style="font-size:11px; color:var(--text-muted);">${escapeHtml(item.sub)}</div>` : ""}
          </div>
          <div class="val">${escapeHtml(String(item.val ?? ""))}</div>
        </div>
      `).join("");

      Array.from(el.children).forEach((child, i) => {
        child.addEventListener("click", () => (clickFn ? clickFn(items[i]) : null));
      });
    }

    function buildCsv(rows){
      const esc = (v) => {
        const s = String(v ?? "");
        return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
      };
      return rows.map(r => r.map(esc).join(",")).join("\n");
    }

    function downloadText(filename, text, mime="text/plain;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function saveToStorage(){
      localStorage.setItem(STORAGE_KEYS.text, ELS.textInput.value);
      localStorage.setItem(STORAGE_KEYS.stopwords, ELS.stopwordsInput.value);
      localStorage.setItem(STORAGE_KEYS.densityKeywords, ELS.densityKeywords.value);
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(readSettings()));
      localStorage.setItem(STORAGE_KEYS.mode, state.mode);
    }

    function restoreFromStorage(){
      ELS.textInput.value = localStorage.getItem(STORAGE_KEYS.text) || "";
      ELS.stopwordsInput.value = localStorage.getItem(STORAGE_KEYS.stopwords) || getDefaultStopwordsText();
      ELS.densityKeywords.value = localStorage.getItem(STORAGE_KEYS.densityKeywords) || "";

      const s = localStorage.getItem(STORAGE_KEYS.settings);
      if(s){
        try { applySettings(JSON.parse(s)); }
        catch(_){ applySettings(DEFAULTS); }
      } else {
        applySettings(DEFAULTS);
      }

      updateCheckboxPills();
    }

    function clearOnlyAppStorage(){
      Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
    }

    function analyze(){
      const raw = ELS.textInput.value || "";
      const settings = readSettings();
      const stopwordsSet = parseStopwords(ELS.stopwordsInput.value);

      const tokens = tokenizeWithOffsets(raw, settings.countNumbers);
      state.tokens = tokens;
      renderPreview(raw, tokens);

      const sentences = splitSentencesWithOffsets(raw);
      const paragraphs = countParagraphs(raw);

      ELS.statWords.textContent = formatNumber(tokens.length);
      ELS.statChars.textContent = formatNumber(raw.length);
      ELS.statSents.textContent = formatNumber(sentences.length);
      ELS.statRead.textContent = estimateReadingTime(tokens.length);
      ELS.statLenSub.textContent = `Avg: ${(tokens.length / Math.max(1, sentences.length)).toFixed(1)} words`;

      const counts = new Map();
      for(const t of tokens){
        if(settings.useStopwords && stopwordsSet.has(t.norm)) continue;
        counts.set(t.norm, (counts.get(t.norm) || 0) + 1);
      }
      ELS.statWordsSub.textContent = `unique: ${formatNumber(counts.size)}`;

      const sortedWords = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0, settings.topN);
      state.wordCounts = sortedWords;

      renderList(
        ELS.topWordsBody,
        sortedWords.map(([w,c]) => ({ label: w, val: c })),
        (item) => highlightWord(item.label)
      );

      const ngrams = [];
      if(settings.ng2) ngrams.push(...buildNgrams(tokens, stopwordsSet, 2, settings.useStopwords));
      if(settings.ng3) ngrams.push(...buildNgrams(tokens, stopwordsSet, 3, settings.useStopwords));
      ngrams.sort((a,b)=>b.count-a.count);
      state.ngramCounts = ngrams;

      /* ‚úÖ ÌÅ¥Î¶≠ Ïãú n-gram ÌïòÏù¥ÎùºÏù¥Ìä∏ */
      renderList(
        ELS.ngramsBody,
        ngrams.slice(0, settings.topN).map(x => ({ label: x.text, val: x.count })),
        (item) => highlightNgram(item.label)
      );

      // Readability (EN)
      let enWords=0, syllables=0, enSents=0;
      for(const s of sentences){
        const w = tokenizeEnglishWords(s.text);
        if(w.length > 0){
          enSents++;
          enWords += w.length;
          for(const wd of w) syllables += estimateSyllables(wd);
        }
      }
      if(enWords > 5 && enSents > 0){
        const wps = enWords / enSents;
        const spw = syllables / enWords;
        const re = 206.835 - 1.015*wps - 84.6*spw;
        const gr = 0.39*wps + 11.8*spw - 15.59;
        ELS.fleschRE.textContent = re.toFixed(1);
        ELS.fkGrade.textContent = gr.toFixed(1);
        ELS.enCounts.textContent = `${enWords} words / ${syllables} syllables (est.) / ${enSents} EN sentences`;
      } else {
        ELS.fleschRE.textContent = "‚Äî";
        ELS.fkGrade.textContent = "‚Äî";
        ELS.enCounts.textContent = "Insufficient English text";
      }

      // Long sentences
      const longSents = [];
      const threshold = Math.max(1, settings.longSentenceThreshold);
      for(const s of sentences){
        const len = tokenizeWithOffsets(s.text, settings.countNumbers).length;
        if(len >= threshold) longSents.push({ ...s, len });
      }
      renderList(
        ELS.longSentencesList,
        longSents.map(s => ({
          label: `${s.len} words`,
          sub: s.text.replace(/\s+/g," ").slice(0, 90) + (s.text.length > 90 ? "..." : ""),
          val: "Jump",
          start: s.start,
          end: s.end
        })),
        (item) => highlightRange(item.start, item.end, true)
      );

      // Passive suspects
      const passive = [];
      const BE = new Set(["am","is","are","was","were","be","been","being"]);
      for(const s of sentences){
        const w = tokenizeEnglishWords(s.text);
        for(let i=0; i<w.length-1; i++){
          if(!BE.has(w[i])) continue;

          let j = i+1;
          if(w[j] === "not") j++;
          if(w[j] && w[j].endsWith("ly")) j++;

          const cand = w[j];
          if(cand && (cand.endsWith("ed") || IRREGULAR_PARTICIPLES.has(cand))){
            passive.push({ ...s, match: `${w[i]} ‚Ä¶ ${cand}` });
            break;
          }
        }
      }
      renderList(
        ELS.passiveList,
        passive.slice(0, 30).map(s => ({
          label: s.match,
          sub: s.text.replace(/\s+/g," ").slice(0, 90) + (s.text.length > 90 ? "..." : ""),
          val: "Jump",
          start: s.start,
          end: s.end
        })),
        (item) => highlightRange(item.start, item.end, true)
      );

      // Local repetition
      const repeats = [];
      const win = Math.max(3, settings.localRepeatWindow);
      const minCount = Math.max(2, settings.overusedMinCount);
      const minLen = 3;

      for(let i=0; i<tokens.length; i++){
        const t = tokens[i];
        if(t.norm.length < minLen) continue;
        if(settings.useStopwords && stopwordsSet.has(t.norm)) continue;

        let c = 1;
        for(let j=i+1; j<Math.min(tokens.length, i+win); j++){
          if(tokens[j].norm === t.norm) c++;
        }
        if(c >= minCount) repeats.push({ word: t.norm, count: c, start: t.start });
      }

      const uniqueRepeats = [];
      const seenRep = new Set();
      repeats.sort((a,b)=>b.count-a.count).forEach(r => {
        if(!seenRep.has(r.word)){
          seenRep.add(r.word);
          uniqueRepeats.push(r);
        }
      });

      renderList(
        ELS.localRepeatList,
        uniqueRepeats.slice(0, 20).map(r => ({
          label: r.word,
          sub: `${r.count} times in ~${win} tokens`,
          val: "Find"
        })),
        (item) => highlightWord(item.label)
      );

      // Transitions
      const transFound = [];
      const lowerRaw = raw.toLowerCase();
      for(const t of TRANSITIONS){
        const re = new RegExp(`\\b${escapeRegex(t)}\\b`, "g");
        const m = lowerRaw.match(re);
        if(m) transFound.push({ term: t, count: m.length });
      }
      transFound.sort((a,b)=>b.count-a.count);
      renderList(
        ELS.transitionBody,
        transFound.map(t => ({ label: t.term, val: t.count })),
        (item) => highlightNgram(item.label)
      );

      // Sections
      const sections = [];
      const lines = raw.split("\n");
      let offset = 0;
      for(const line of lines){
        const trim = line.trim();
        if(trim.startsWith("#") || HEADING_KEYWORDS.includes(trim.toLowerCase()) || /^\d+\.\s+[A-Z]/.test(trim)){
          sections.push({ name: trim, start: offset });
        }
        offset += line.length + 1;
      }

      if(sections.length === 0 && raw.trim().length > 0){
        sections.push({ name: "Whole Document", start: 0 });
      }

      renderList(
        ELS.sectionBody,
        sections.map((s, idx) => ({
          label: s.name || `(heading ${idx+1})`,
          val: "Jump",
          start: s.start,
          end: Math.min(raw.length, s.start + 160)
        })),
        (item) => highlightRange(item.start, item.end, false)
      );

      // Keyword density
      const kws = (ELS.densityKeywords.value || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);

      if(kws.length && sections.length){
        let th = "<tr><th style='padding:8px 6px;'>Sec</th>";
        for(const k of kws) th += `<th style='padding:8px 6px;'>${escapeHtml(k.slice(0, 12))}</th>`;
        th += "</tr>";
        ELS.densityHead.innerHTML = th;

        let tb = "";
        for(let i=0; i<sections.length; i++){
          const secStart = sections[i].start;
          const secEnd = sections[i+1] ? sections[i+1].start : raw.length;
          const secText = raw.slice(secStart, secEnd).toLowerCase();

          tb += `<tr><td style="padding:8px 6px; border-bottom:1px solid var(--border);">${i+1}</td>`;
          for(const k of kws){
            const re = new RegExp(escapeRegex(k.toLowerCase()), "g");
            const c = (secText.match(re) || []).length;

            const alpha = c > 0 ? Math.min(0.75, c/5) : 0;
            const bg = c > 0 ? `rgba(99,102,241,${alpha})` : "transparent";
            const fg = c > 0 ? "#fff" : "inherit";

            tb += `<td style="padding:8px 6px; background:${bg}; color:${fg}; text-align:center; border-bottom:1px solid var(--border);">${c}</td>`;
          }
          tb += `</tr>`;
        }
        ELS.densityBody.innerHTML = tb;
      } else {
        ELS.densityHead.innerHTML = "";
        ELS.densityBody.innerHTML = `<tr><td style="padding:12px; text-align:center; color:var(--text-dim);">Enter keywords to view density</td></tr>`;
      }

      // Citations count
      const citations = [];
      let reCite = /\[\s*\d+(?:[-‚Äì,]\s*\d+)*\s*\]/g;
      let mC;
      while((mC = reCite.exec(raw)) !== null) citations.push(mC[0]);
      reCite = /\(\s*[A-Z][A-Za-z-]+(?:\s+et\s+al\.)?(?:\s*,)?\s*\d{4}[a-z]?(?:\s*;\s*[A-Z][A-Za-z-]+(?:\s+et\s+al\.)?(?:\s*,)?\s*\d{4}[a-z]?)*\s*\)/g;
      while((mC = reCite.exec(raw)) !== null) citations.push(mC[0]);

      const citeCounts = new Map();
      citations.forEach(c => citeCounts.set(c, (citeCounts.get(c)||0)+1));
      renderList(
        ELS.citeBody,
        [...citeCounts.entries()].map(([k,v]) => ({ label: k, val: v, color: "var(--accent)" })),
        (item) => highlightText(item.label)
      );

      // Abbreviations
      const abbrs = [];
      const reAbbr = /([A-Za-z][A-Za-z \-]{3,120}?)\s*\(([A-Z][A-Z0-9\-]{1,9})\)/g;
      let mA;
      while((mA = reAbbr.exec(raw)) !== null){
        abbrs.push({ full: mA[1].trim(), short: mA[2], start: mA.index, end: mA.index + mA[0].length });
        if(mA.index === reAbbr.lastIndex) reAbbr.lastIndex++;
      }

      renderList(
        ELS.abbrBody,
        abbrs.slice(0, 20).map(a => ({ label: a.short, sub: a.full, val: "Jump", start: a.start, end: a.end })),
        (item) => highlightRange(item.start, item.end)
      );

      // Minimal report text
      state.lastReport = `Text Analyzer Report\nWords: ${tokens.length}\nSentences: ${sentences.length}\nParagraphs: ${paragraphs}\n`;
      saveToStorage();
    }

    function bind(){
      ELS.btnReadMode.addEventListener("click", () => setMode("read"));
      ELS.btnEditMode.addEventListener("click", () => setMode("edit"));
      
      ELS.btnSwapTheme.addEventListener("click", () => {
        ELS.mainPanel.classList.toggle("swapped");
        toast("Theme Swapped");
      });

      ELS.preview.addEventListener("dblclick", () => {
        setMode("edit");
      });

      [ELS.textInput, ELS.stopwordsInput, ELS.densityKeywords].forEach(el => el.addEventListener("input", analyze));
      document.querySelectorAll("input[type=number], input[type=checkbox]").forEach(el =>
        el.addEventListener("change", () => { updateCheckboxPills(); analyze(); })
      );

      ELS.clearHitBtn.addEventListener("click", () => {
        ELS.textInput.value = "";
        analyze();
        toast("Content Cleared");
      });

      ELS.resetStopwordsBtn.addEventListener("click", () => {
        ELS.stopwordsInput.value = getDefaultStopwordsText();
        analyze();
        toast("Stopwords Reset");
      });

      ELS.clearStorageBtn.addEventListener("click", () => {
        clearOnlyAppStorage();
        toast("Cache cleared");
        setTimeout(() => location.reload(), 250);
      });

      ELS.resetAllBtn.addEventListener("click", () => {
        clearOnlyAppStorage();
        ELS.textInput.value = "";
        ELS.densityKeywords.value = "";
        ELS.stopwordsInput.value = getDefaultStopwordsText();
        applySettings(DEFAULTS);
        updateCheckboxPills();
        clearHighlights();
        analyze();
        toast("Reset All");
      });

      ELS.exportReportBtn.addEventListener("click", () => {
        const name = `report_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.txt`;
        downloadText(name, state.lastReport || "");
        toast("Report downloaded");
      });

      ELS.exportWordsCsvBtn.addEventListener("click", () => {
        const rows = [["word","count"], ...(state.wordCounts || []).map(([w,c]) => [w, c])];
        downloadText("words.csv", buildCsv(rows), "text/csv;charset=utf-8");
        toast("Words CSV downloaded");
      });

      ELS.exportNgramsCsvBtn.addEventListener("click", () => {
        const rows = [["ngram","count"], ...(state.ngramCounts || []).map(x => [x.text, x.count])];
        downloadText("ngrams.csv", buildCsv(rows), "text/csv;charset=utf-8");
        toast("N-grams CSV downloaded");
      });

      ELS.copyReportBtn.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(state.lastReport || "");
          toast("Report Copied");
        }catch(_){
          toast("Clipboard blocked");
        }
      });

      ELS.exportStopwordsBtn.addEventListener("click", () => {
        downloadText("stopwords.txt", ELS.stopwordsInput.value || "");
        toast("Stopwords exported");
      });

      ELS.importStopwordsBtn.addEventListener("click", () => {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = ".txt,text/plain";
        inp.addEventListener("change", async () => {
          const f = inp.files && inp.files[0];
          if(!f) return;
          ELS.stopwordsInput.value = await f.text();
          analyze();
          toast("Stopwords imported");
        });
        inp.click();
      });
    }

    restoreFromStorage();
    bind();
    updateCheckboxPills();

    // Ï¥àÍ∏∞ Î™®Îìú Î≥µÏõê
    setMode(state.mode === "edit" ? "edit" : "read", { skipAnalyze: true, noFocus: true });
    analyze();
  </script>
</body>
</html>
