<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tafel Plot Analyzer - Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=SF+Mono:wght@400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    colors: {
                        ios: {
                            bg: '#F5F5F7',       // System Grouped Background
                            card: '#FFFFFF',     // System Background
                            blue: '#007AFF',     // System Blue
                            red: '#FF3B30',      // System Red
                            gray: '#8E8E93',     // System Gray
                            border: '#E5E5EA',   // System Separator
                            input: '#F2F2F7',    // System Fill
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03), 0 1px 2px rgba(0,0,0,0.02)',
                        'float': '0 8px 30px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F5F5F7;
            color: #1D1D1F;
            -webkit-font-smoothing: antialiased;
        }

        /* Apple-style Card */
        .ios-card {
            background: #FFFFFF;
            border-radius: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* Apple-style Input */
        .ios-input {
            background-color: #F2F2F7;
            border: 1px solid transparent;
            color: #1D1D1F;
            transition: all 0.2s ease;
        }
        .ios-input:focus {
            background-color: #FFFFFF;
            border-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
            outline: none;
        }

        /* Toggle Switch (iOS Style) */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34C759;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34C759;
        }
        
        /* Custom Scrollbar (Subtle) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }

        #myChart { cursor: crosshair; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8 font-sans">

    <!-- Header -->
    <header class="w-full max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center px-2">
        <div>
            <h1 class="text-3xl font-semibold tracking-tight text-[#1D1D1F]">
                Tafel Analyzer
            </h1>
        </div>
        <div class="mt-4 md:mt-0">
             <span class="px-3 py-1 rounded-full bg-[#E5E5EA] text-[#8E8E93] text-xs font-semibold">
                Electrochemical Analysis by Echem AI Research
             </span>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">

        <!-- Left Column: Controls (4 cols) -->
        <div class="lg:col-span-4 flex flex-col gap-6">
            
            <!-- Parameters Card -->
            <div class="ios-card p-6">
                <div class="flex items-center justify-between mb-6 border-b border-ios-border pb-4">
                    <h2 class="text-lg font-semibold text-[#1D1D1F]">Parameters</h2>
                </div>

                <!-- Eeq Input -->
                <div class="mb-6">
                    <label for="eeqInput" class="block text-xs font-medium text-[#86868B] uppercase tracking-wide mb-2">
                        Equilibrium Potential (E<sub>eq</sub>)
                    </label>
                    <div class="relative">
                        <input type="number" id="eeqInput" step="0.01" class="ios-input w-full p-3 rounded-xl font-mono text-sm" placeholder="Optional (e.g. -0.20)">
                        <span class="absolute right-4 top-3 text-gray-400 text-sm">V</span>
                    </div>
                </div>

                <!-- Toggle -->
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-[#1D1D1F]">Swap Axes</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="swapAxesBtn" class="sr-only peer">
                        <div class="w-11 h-6 bg-[#E5E5EA] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#34C759]"></div>
                    </label>
                </div>
                <p class="text-xs text-[#86868B] mb-6">Switch between X:logI and X:V</p>

                <!-- Data Input -->
                <div>
                    <label for="dataInput" class="block text-xs font-medium text-[#86868B] uppercase tracking-wide mb-2 flex justify-between">
                        <span>CSV Data</span>
                        <span class="text-[10px] normal-case bg-[#F2F2F7] px-2 py-0.5 rounded text-[#8E8E93]">Paste V, I</span>
                    </label>
                    <textarea id="dataInput" class="ios-input w-full p-3 rounded-xl font-mono text-xs leading-relaxed h-28 resize-y focus:ring-0" spellcheck="false" placeholder="0.010, 3.5e-6...">
0.010,3.596848e-06
0.020,7.308867e-06
0.030,1.151029e-05
0.040,1.573298e-05
0.050,2.075766e-05
0.060,2.798520e-05
0.070,3.787921e-05
0.080,5.062745e-05
0.090,6.737918e-05
0.100,8.904928e-05
0.110,1.177637e-04
0.120,1.555987e-04
0.130,2.054454e-04
0.140,2.708300e-04
0.150,3.502746e-04
0.160,4.330262e-04
0.170,5.040020e-04
0.180,5.519374e-04
0.190,5.778246e-04
0.200,5.913801e-04
0.210,6.046714e-04
0.220,6.147303e-04
0.230,6.267667e-04
0.240,6.287609e-04
0.250,6.330438e-04</textarea>
                </div>
            </div>

            <!-- Analysis Results Card -->
            <div class="ios-card p-6">
                <h2 class="text-lg font-semibold text-[#1D1D1F] mb-4">Results</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-baseline pb-3 border-b border-ios-border">
                        <span class="text-sm text-[#86868B]">Tafel Slope</span>
                        <div id="slope-result" class="text-right">
                            <div class="text-lg font-semibold text-[#1D1D1F] font-mono">-</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-baseline pb-3 border-b border-ios-border">
                        <span class="text-sm text-[#86868B]">Exchange Current (I<sub>0</sub>)</span>
                        <div id="i0-result" class="text-lg font-semibold text-[#1D1D1F] font-mono">-</div>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm text-[#86868B]">R-Squared (R²)</span>
                        <span id="r2-result" class="text-sm font-medium font-mono text-[#8E8E93]">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Visualization (8 cols) -->
        <div class="lg:col-span-8 flex flex-col">
            <!-- Changed h-[480px] to h-full to match left column height -->
            <div class="ios-card p-6 flex flex-col h-full relative overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-semibold text-[#1D1D1F]">Plot</h2>
                        <span class="text-xs text-[#86868B] bg-[#F2F2F7] px-2 py-1 rounded">Drag to calculate</span>
                    </div>
                    <!-- Legend -->
                    <div class="flex gap-4">
                        <div class="flex items-center text-xs font-medium text-[#1D1D1F]">
                            <span class="w-2.5 h-2.5 rounded-full bg-[#007AFF] mr-2"></span> Data
                        </div>
                        <div class="flex items-center text-xs font-medium text-[#1D1D1F]">
                            <span class="w-2.5 h-2.5 rounded-full bg-[#FF3B30] mr-2"></span> Fit
                        </div>
                    </div>
                </div>
                
                <!-- Chart Container stretches to fill remaining height -->
                <div class="relative flex-grow w-full min-h-[400px]">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <script>
    const dataInput = document.getElementById('dataInput');
    const eeqInput = document.getElementById('eeqInput');
    const swapAxesBtn = document.getElementById('swapAxesBtn');
    const slopeResult = document.getElementById('slope-result');
    const i0Result = document.getElementById('i0-result');
    const r2Result = document.getElementById('r2-result');
    const canvas = document.getElementById('myChart');
    const ctx = canvas.getContext('2d');
    let chartInstance = null;

    let isDragging = false;
    let selectionRect = { startX: 0, endX: 0 };
    let selectionRange = { min: null, max: null };

    // --- Core Logic (Unchanged) ---
    function calculateLinearRegression(dataPoints) {
        if (dataPoints.length < 2) return { slope: 0, intercept: 0, rSquared: 0 };
        const n = dataPoints.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        dataPoints.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumX2 += p.x * p.x; });
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        let ssTot = 0, ssRes = 0;
        const yMean = sumY / n;
        dataPoints.forEach(p => {
            const predictedY = slope * p.x + intercept;
            ssTot += Math.pow(p.y - yMean, 2);
            ssRes += Math.pow(p.y - predictedY, 2);
        });
        const rSquared = (ssTot === 0) ? 1 : 1 - (ssRes / ssTot);
        
        return { slope, intercept, rSquared };
    }

    const selectionPlugin = {
        id: 'selectionPlugin',
        beforeDatasetsDraw: (chart) => {
            const { ctx, chartArea, scales: { x } } = chart;
            if (selectionRange.min !== null && selectionRange.max !== null) {
                const startX = x.getPixelForValue(selectionRange.min);
                const endX = x.getPixelForValue(selectionRange.max);
                
                ctx.save();
                ctx.fillStyle = 'rgba(0, 122, 255, 0.1)'; // iOS Blue tint
                ctx.fillRect(Math.min(startX, endX), chartArea.top, Math.abs(endX - startX), chartArea.height);
                ctx.restore();
            }
        },
        afterDraw: (chart) => {
            if (isDragging) {
                const { ctx, chartArea } = chart;
                ctx.save();
                ctx.fillStyle = 'rgba(0, 122, 255, 0.15)'; // Dragging color
                const rectX = Math.min(selectionRect.startX, selectionRect.endX);
                const rectWidth = Math.abs(selectionRect.endX - selectionRect.startX);
                ctx.fillRect(rectX, chartArea.top, rectWidth, chartArea.height);
                ctx.restore();
            }
        }
    };
    Chart.register(selectionPlugin);

    // Set Global Chart Defaults for Apple Theme
    Chart.defaults.color = '#8E8E93';
    Chart.defaults.borderColor = '#E5E5EA';
    Chart.defaults.font.family = "'Inter', sans-serif";

    function analyzeAndPlot() {
        if (chartInstance) chartInstance.destroy();

        const rawData = dataInput.value.trim();
        const eeqVal = parseFloat(eeqInput.value);
        const hasEeq = !isNaN(eeqVal);
        const isSwapped = swapAxesBtn.checked;

        if (!rawData) return;

        const lines = rawData.split('\n');
        const allDataPoints = [];
        
        lines.forEach(line => {
            const parts = line.replace(/[,;\t]+/g, ' ').trim().split(/\s+/);
            if (parts.length >= 2) {
                const potential = parseFloat(parts[0]);
                const current = parseFloat(parts[1]);
                
                if (!isNaN(potential) && !isNaN(current) && current !== 0) {
                    let xVal = hasEeq ? (potential - eeqVal) : potential;
                    let yVal = Math.log10(Math.abs(current));
                    
                    if (isSwapped) [xVal, yVal] = [yVal, xVal];
                    allDataPoints.push({ x: xVal, y: yVal });
                }
            }
        });

        if (allDataPoints.length === 0) return;

        const pointsForFitting = selectionRange.min === null ? 
            [] : 
            allDataPoints.filter(p => p.x >= selectionRange.min && p.x <= selectionRange.max);

        const regression = (selectionRange.min !== null && pointsForFitting.length >= 2) ? calculateLinearRegression(pointsForFitting) : null;

        // Styling: Clean Blue dots
        const pointColors = allDataPoints.map(p => 
            (selectionRange.min !== null && p.x >= selectionRange.min && p.x <= selectionRange.max) ?
            '#007AFF' : // Selected: System Blue
            '#C7C7CC'); // Unselected: System Gray 4

        const datasets = [{
            label: 'Experimental Data',
            data: allDataPoints,
            backgroundColor: pointColors,
            borderColor: pointColors, 
            pointRadius: 4,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#007AFF',
            type: 'scatter'
        }];

        if (regression) {
            const minX = Math.min(...pointsForFitting.map(p => p.x));
            const maxX = Math.max(...pointsForFitting.map(p => p.x));
            const padding = (maxX - minX) * 0.2;
            
            const x1 = minX - padding;
            const x2 = maxX + padding;

            datasets.push({
                label: 'Tafel Fit',
                data: [{ x: x1, y: regression.slope * x1 + regression.intercept }, { x: x2, y: regression.slope * x2 + regression.intercept }],
                borderColor: '#FF3B30', // System Red
                borderWidth: 2,
                borderDash: [6, 4],
                pointRadius: 0,
                type: 'line',
                tension: 0
            });

            let slopeVdec, slopeDecV;
            if (isSwapped) {
                slopeVdec = Math.abs(regression.slope);
                slopeDecV = 1 / slopeVdec;
                // Styling updated to match I0 (dark text)
                slopeResult.innerHTML = `
                    <div class="text-lg font-semibold text-[#1D1D1F] font-mono">${slopeVdec.toFixed(4)} <span class="text-xs text-[#8E8E93] font-sans font-normal">V/dec</span></div>
                    <div class="text-xs text-[#8E8E93] font-sans font-normal mt-0.5">(${slopeDecV.toFixed(4)} dec/V)</div>`;
            } else {
                slopeDecV = Math.abs(regression.slope);
                slopeVdec = 1 / slopeDecV;
                // Styling updated to match I0 (dark text)
                slopeResult.innerHTML = `
                    <div class="text-lg font-semibold text-[#1D1D1F] font-mono">${slopeDecV.toFixed(4)} <span class="text-xs text-[#8E8E93] font-sans font-normal">dec/V</span></div>
                    <div class="text-xs text-[#8E8E93] font-sans font-normal mt-0.5">(${slopeVdec.toFixed(4)} V/dec)</div>`;
            }

            if(hasEeq) {
                let i0;
                if (!isSwapped) i0 = Math.pow(10, regression.intercept);
                else i0 = Math.pow(10, -regression.intercept / regression.slope);
                
                const [base, exp] = i0.toExponential(3).split('e');
                i0Result.innerHTML = `${base} × 10<sup class="text-xs">${parseInt(exp)}</sup> <span class="text-xs text-[#8E8E93] font-sans font-normal">A</span>`;
            } else {
                i0Result.textContent = "-";
            }

            r2Result.textContent = regression.rSquared.toFixed(4);
            r2Result.className = regression.rSquared > 0.99 ? "text-[#34C759] font-bold" : "text-[#8E8E93]";
        } else {
            slopeResult.textContent = '-';
            i0Result.textContent = '-';
            r2Result.textContent = '-';
        }
        
        const labelV = hasEeq ? 'Overpotential (V)' : 'Potential (V)';
        const labelI = 'log |Current| (A)';

        chartInstance = new Chart(ctx, {
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                scales: {
                    x: { 
                        type: 'linear', 
                        title: { display: true, text: isSwapped ? labelI : labelV, font: { size: 13, weight: '500' }, color: '#1D1D1F' },
                        grid: { color: '#F2F2F7', drawBorder: false },
                        ticks: { font: { size: 11 }, color: '#8E8E93' }
                    },
                    y: { 
                        type: 'linear', 
                        title: { display: true, text: isSwapped ? labelV : labelI, font: { size: 13, weight: '500' }, color: '#1D1D1F' },
                        grid: { color: '#F2F2F7', drawBorder: false },
                        ticks: { font: { size: 11 }, color: '#8E8E93' }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Using custom legend in HTML
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1D1D1F',
                        bodyColor: '#1D1D1F',
                        borderColor: 'rgba(0, 0, 0, 0.05)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 12,
                        titleFont: { family: 'Inter', size: 13, weight: '600' },
                        bodyFont: { family: 'SF Mono', size: 12 },
                        boxPadding: 4,
                        callbacks: { 
                            label: (c) => {
                                const x = c.parsed.x.toFixed(3);
                                const y = c.parsed.y.toFixed(3);
                                return isSwapped ? `log I: ${x}, ${hasEeq?'η':'V'}: ${y}` : `${hasEeq?'η':'V'}: ${x}, log I: ${y}`;
                            }
                        }
                    }
                }
            }
        });
    }

    canvas.addEventListener('mousedown', (e) => {
        isDragging = true;
        selectionRect.startX = e.offsetX;
        selectionRect.endX = e.offsetX;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isDragging) {
            selectionRect.endX = e.offsetX;
            chartInstance.update('none'); 
        }
    });

    canvas.addEventListener('mouseup', (e) => {
        if (isDragging) {
            isDragging = false;
            const scale = chartInstance.scales.x;
            const startVal = scale.getValueForPixel(selectionRect.startX);
            const endVal = scale.getValueForPixel(selectionRect.endX);
            selectionRange.min = Math.min(startVal, endVal);
            selectionRange.max = Math.max(startVal, endVal);
            analyzeAndPlot(); 
        }
    });

    canvas.addEventListener('dblclick', () => {
        selectionRange.min = null;
        selectionRange.max = null;
        analyzeAndPlot();
    });

    dataInput.addEventListener('input', () => setTimeout(analyzeAndPlot, 100));
    eeqInput.addEventListener('input', () => setTimeout(analyzeAndPlot, 100));
    swapAxesBtn.addEventListener('change', () => analyzeAndPlot());

    window.onload = () => {
        analyzeAndPlot();
    };
    </script>
</body>
</html>